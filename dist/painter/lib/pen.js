"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var s=0,e=new Array(t.length);s<t.length;s++)e[s]=t[s];return e}}function _classCallCheck(t,s){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,s){for(var e=0;e<s.length;e++){var i=s[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,s,e){return s&&_defineProperties(t.prototype,s),e&&_defineProperties(t,e),t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var QR=require("./qrcode.js"),GD=require("./gradient.js"),Painter=function(){function e(t,s){_classCallCheck(this,e),this.ctx=t,this.data=s,this.globalWidth={},this.globalHeight={}}return _createClass(e,[{key:"paint",value:function(t){this.style={width:this.data.width.toPx(),height:this.data.height.toPx()},this._background();var s=!0,e=!1,i=void 0;try{for(var r,a=this.data.views[Symbol.iterator]();!(s=(r=a.next()).done);s=!0){var h=r.value;this._drawAbsolute(h)}}catch(t){e=!0,i=t}finally{try{s||null==a.return||a.return()}finally{if(e)throw i}}this.ctx.draw(!1,function(){t()})}},{key:"_background",value:function(){this.ctx.save();var t=this.style,s=t.width,e=t.height,i=this.data.background;this.ctx.translate(s/2,e/2),this._doClip(this.data.borderRadius,s,e),i?i.startsWith("#")||i.startsWith("rgba")||"transparent"===i.toLowerCase()?(this.ctx.fillStyle=i,this.ctx.fillRect(-s/2,-e/2,s,e)):GD.api.isGradient(i)?(GD.api.doGradient(i,s,e,this.ctx),this.ctx.fillRect(-s/2,-e/2,s,e)):this.ctx.drawImage(i,-s/2,-e/2,s,e):(this.ctx.fillStyle="#fff",this.ctx.fillRect(-s/2,-e/2,s,e)),this.ctx.restore()}},{key:"_drawAbsolute",value:function(t){switch(t.css&&t.css.length&&(t.css=Object.assign.apply(Object,_toConsumableArray(t.css))),t.type){case"image":this._drawAbsImage(t);break;case"text":this._fillAbsText(t);break;case"rect":this._drawAbsRect(t);break;case"qrcode":this._drawQRCode(t)}}},{key:"_doClip",value:function(t,s,e){if(t&&s&&e){var i=Math.min(t.toPx(),s/2,e/2);this.ctx.globalAlpha=0,this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(-s/2+i,-e/2+i,i,1*Math.PI,1.5*Math.PI),this.ctx.lineTo(s/2-i,-e/2),this.ctx.arc(s/2-i,-e/2+i,i,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(s/2,e/2-i),this.ctx.arc(s/2-i,e/2-i,i,0,.5*Math.PI),this.ctx.lineTo(-s/2+i,e/2),this.ctx.arc(-s/2+i,e/2-i,i,.5*Math.PI,1*Math.PI),this.ctx.closePath(),this.ctx.fill(),getApp().systemInfo&&getApp().systemInfo.version<="6.6.6"&&"ios"===getApp().systemInfo.platform||this.ctx.clip(),this.ctx.globalAlpha=1}}},{key:"_doBorder",value:function(t,s,e){if(t.css){var i=t.css,r=i.borderRadius,a=i.borderWidth,h=i.borderColor;if(a){var c;this.ctx.save(),this._preProcess(t,!0),c=r?Math.min(r.toPx(),s/2,e/2):0;var o=a.toPx();this.ctx.lineWidth=o,this.ctx.strokeStyle=h||"black",this.ctx.beginPath(),this.ctx.arc(-s/2+c,-e/2+c,c+o/2,1*Math.PI,1.5*Math.PI),this.ctx.lineTo(s/2-c,-e/2-o/2),this.ctx.arc(s/2-c,-e/2+c,c+o/2,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(s/2+o/2,e/2-c),this.ctx.arc(s/2-c,e/2-c,c+o/2,0,.5*Math.PI),this.ctx.lineTo(-s/2+c,e/2+o/2),this.ctx.arc(-s/2+c,e/2-c,c+o/2,.5*Math.PI,1*Math.PI),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()}}}},{key:"_preProcess",value:function(t,s){var e,i,r,a,h=0;switch(t.type){case"text":for(var c=t.text.split("\n"),o=0;o<c.length;++o)""===c[o]&&(c[o]=" ");var l="bold"===t.css.fontWeight?"bold":"normal";t.css.fontSize=t.css.fontSize?t.css.fontSize:"20rpx",this.ctx.font="normal ".concat(l," ").concat(t.css.fontSize.toPx(),"px ").concat(t.css.fontFamily?t.css.fontFamily:"sans-serif");for(var n=0,x=[],d=0;d<c.length;++d){var f=this.ctx.measureText(c[d]).width,g=t.css.width?t.css.width.toPx():f,u=Math.ceil(f/g);h=h<g?g:h,n+=u,x[d]=u}n=t.css.maxLines<n?t.css.maxLines:n;var b=t.css.lineHeight?t.css.lineHeight.toPx():t.css.fontSize.toPx();e=b*n,i={lines:n,lineHeight:b,textArray:c,linesArray:x};break;case"image":var P=getApp().systemInfo.pixelRatio?getApp().systemInfo.pixelRatio:2;t.css&&(t.css.width||(t.css.width="auto"),t.css.height||(t.css.height="auto")),!t.css||"auto"===t.css.width&&"auto"===t.css.height?(h=Math.round(t.sWidth/P),e=Math.round(t.sHeight/P)):"auto"===t.css.width?(e=t.css.height.toPx(),h=t.sWidth/t.sHeight*e):e="auto"===t.css.height?(h=t.css.width.toPx(),t.sHeight/t.sWidth*h):(h=t.css.width.toPx(),t.css.height.toPx());break;default:if(!t.css.width||!t.css.height)return void console.error("You should set width and height");h=t.css.width.toPx(),e=t.css.height.toPx()}if(t.css&&t.css.right)if("string"==typeof t.css.right)r=this.style.width-t.css.right.toPx(!0);else{var p=t.css.right;r=this.style.width-p[0].toPx(!0)-this.globalWidth[p[1]]*(p[2]||1)}else if(t.css&&t.css.left)if("string"==typeof t.css.left)r=t.css.left.toPx(!0);else{var v=t.css.left;r=v[0].toPx(!0)+this.globalWidth[v[1]]*(v[2]||1)}else r=0;if(t.css&&t.css.bottom)a=this.style.height-e-t.css.bottom.toPx(!0);else if(t.css&&t.css.top)if("string"==typeof t.css.top)a=t.css.top.toPx(!0);else{var y=t.css.top;a=y[0].toPx(!0)+this.globalHeight[y[1]]*(y[2]||1)}else a=0;var w=t.css&&t.css.rotate?this._getAngle(t.css.rotate):0;switch(t.css&&t.css.align?t.css.align:t.css&&t.css.right?"right":"left"){case"center":this.ctx.translate(r,a+e/2);break;case"right":this.ctx.translate(r-h/2,a+e/2);break;default:this.ctx.translate(r+h/2,a+e/2)}return this.ctx.rotate(w),!s&&t.css&&t.css.borderRadius&&"rect"!==t.type&&this._doClip(t.css.borderRadius,h,e),this._doShadow(t),t.id&&(this.globalWidth[t.id]=h,this.globalHeight[t.id]=e),{width:h,height:e,x:r,y:a,extra:i}}},{key:"_doBackground",value:function(t){this.ctx.save();var s=this._preProcess(t,!0),e=s.width,i=s.height,r=t.css,a=r.background,h=r.padding,c=[0,0,0,0];if(h){var o=h.split(/\s+/);if(1===o.length){var l=o[0].toPx();c=[l,l,l,l]}if(2===o.length){var n=o[0].toPx(),x=o[1].toPx();c=[n,x,n,x]}if(3===o.length){var d=o[0].toPx(),f=o[1].toPx();c=[d,f,o[2].toPx(),f]}if(4===o.length)c=[o[0].toPx(),o[1].toPx(),o[2].toPx(),o[3].toPx()]}var g=e+c[1]+c[3],u=i+c[0]+c[2];this._doClip(t.css.borderRadius,g,u),GD.api.isGradient(a)?GD.api.doGradient(a,g,u,this.ctx):this.ctx.fillStyle=a,this.ctx.fillRect(-g/2,-u/2,g,u),this.ctx.restore()}},{key:"_drawQRCode",value:function(t){this.ctx.save();var s=this._preProcess(t),e=s.width,i=s.height;QR.api.draw(t.content,this.ctx,-e/2,-i/2,e,i,t.css.background,t.css.color),this.ctx.restore(),this._doBorder(t,e,i)}},{key:"_drawAbsImage",value:function(t){if(t.url){this.ctx.save();var s=this._preProcess(t),e=s.width,i=s.height,r=t.sWidth,a=t.sHeight,h=0,c=0,o=e/i;t.sWidth/t.sHeight<=o?(a=r/o,c=Math.round((t.sHeight-a)/2)):(r=a*o,h=Math.round((t.sWidth-r)/2)),t.css&&"scaleToFill"===t.css.mode?this.ctx.drawImage(t.url,-e/2,-i/2,e,i):this.ctx.drawImage(t.url,h,c,r,a,-e/2,-i/2,e,i),this.ctx.restore(),this._doBorder(t,e,i)}}},{key:"_fillAbsText",value:function(t){if(t.text){t.css.background&&this._doBackground(t),this.ctx.save();var s=this._preProcess(t,t.css.background&&t.css.borderRadius),e=s.width,i=s.height,r=s.extra;this.ctx.fillStyle=t.css.color||"black";var a=r.lines,h=r.lineHeight,c=r.textArray,o=r.linesArray;if(t.id){for(var l=0,n=0;n<c.length;++n)l=this.ctx.measureText(c[n]).width>l?this.ctx.measureText(c[n]).width:l;this.globalWidth[t.id]=e?l<e?l:e:l}for(var x=0,d=0;d<c.length;++d)for(var f=Math.round(c[d].length/o[d]),g=0,u=0,b=0;b<o[d]&&!(a<=x);++b){u=f;for(var P=c[d].substr(g,u),p=this.ctx.measureText(P).width;g+u<=c[d].length&&(e-p>t.css.fontSize.toPx()||e<p);){if(p<e)P=c[d].substr(g,++u);else{if(P.length<=1)break;P=c[d].substr(g,--u)}p=this.ctx.measureText(P).width}if(g+=P.length,x===a-1&&(d<c.length-1||g<c[d].length)){for(;this.ctx.measureText("".concat(P,"...")).width>e&&!(P.length<=1);)P=P.substring(0,P.length-1);P+="...",p=this.ctx.measureText(P).width}this.ctx.setTextAlign(t.css.textAlign?t.css.textAlign:"left");var v=void 0;switch(t.css.textAlign){case"center":v=0;break;case"right":v=e/2;break;default:v=-e/2}var y=-i/2+(0===x?t.css.fontSize.toPx():t.css.fontSize.toPx()+x*h);x++,"stroke"===t.css.textStyle?this.ctx.strokeText(P,v,y,p):this.ctx.fillText(P,v,y,p);var w=t.css.fontSize.toPx();t.css.textDecoration&&(this.ctx.beginPath(),/\bunderline\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(v,y),this.ctx.lineTo(v+p,y)),/\boverline\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(v,y-w),this.ctx.lineTo(v+p,y-w)),/\bline-through\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(v,y-w/3),this.ctx.lineTo(v+p,y-w/3)),this.ctx.closePath(),this.ctx.strokeStyle=t.css.color,this.ctx.stroke())}this.ctx.restore(),this._doBorder(t,e,i)}}},{key:"_drawAbsRect",value:function(t){this.ctx.save();var s=this._preProcess(t),e=s.width,i=s.height;GD.api.isGradient(t.css.color)?GD.api.doGradient(t.css.color,e,i,this.ctx):this.ctx.fillStyle=t.css.color;var r=t.css.borderRadius,a=r?Math.min(r.toPx(),e/2,i/2):0;this.ctx.beginPath(),this.ctx.arc(-e/2+a,-i/2+a,a,1*Math.PI,1.5*Math.PI),this.ctx.lineTo(e/2-a,-i/2),this.ctx.arc(e/2-a,-i/2+a,a,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(e/2,i/2-a),this.ctx.arc(e/2-a,i/2-a,a,0,.5*Math.PI),this.ctx.lineTo(-e/2+a,i/2),this.ctx.arc(-e/2+a,i/2-a,a,.5*Math.PI,1*Math.PI),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore(),this._doBorder(t,e,i)}},{key:"_doShadow",value:function(t){if(t.css&&t.css.shadow){var s=t.css.shadow.replace(/,\s+/g,",").split(" ");4<s.length?console.error("shadow don't spread option"):(this.ctx.shadowOffsetX=parseInt(s[0],10),this.ctx.shadowOffsetY=parseInt(s[1],10),this.ctx.shadowBlur=parseInt(s[2],10),this.ctx.shadowColor=s[3])}}},{key:"_getAngle",value:function(t){return Number(t)*Math.PI/180}}]),e}();exports.default=Painter;