"use strict";var innerAudioContext=wx.createInnerAudioContext(),APP=getApp(),readyTimer=null,rainTimer=null,redEnvelopes=[],animation=null,minWidth=30,maxWidth=40;Component({properties:{visible:{type:Boolean,value:!1},time:{type:Number,value:10},readyTime:{type:Number,value:3},createSpeed:{type:Number,value:5},min:{type:Number,value:0},max:{type:Number,value:3}},data:{showRainTotalTime:10,showStatus:1,windowWidth:375,windowHeight:555,rainResult:{},loading:!1,showScore:0,showChangeScore:0,scoreStyle:""},ready:function(){redEnvelopes=[],clearTimeout(readyTimer),clearTimeout(rainTimer),this.cancelCustomAnimationFrame(animation),this.cultdown();var t=APP.globalData.systemInfo,e=t.windowWidth,i=t.windowHeight;this.data.windowWidth=e,this.data.windowWidth=i},detached:function(){readyTimer&&clearInterval(readyTimer),rainTimer&&clearInterval(rainTimer),animation&&this.cancelCustomAnimationFrame(animation)},methods:{cultdown:function(){var t=this,e=this.data.readyTime;readyTimer=setInterval(function(){--e<=0&&(clearInterval(readyTimer),t.showRain()),t.setData({readyTime:e})},1e3)},showRain:function(){var t=this;this.setData({showStatus:2}),this.initRain(),this.ininProgress();var e=this.data.time;rainTimer=setInterval(function(){--e<=0&&(clearInterval(rainTimer),animation&&(t.showRainResult(),t.cancelCustomAnimationFrame(animation))),t.setData({showRainTotalTime:e})},1e3)},ininProgress:function(){var t=this.data.time,e=wx.createAnimation({duration:1e3*t});e.translateX(-120).step(),this.setData({progressAni:e.export()})},animationOfScore:function(t,e){var i=wx.createAnimation({duration:0});i.left(t).top(e).step(),this.setData({scoreAni:i.export()});var n=wx.createAnimation({duration:300,timingFunction:"ease"});n.opacity(1).step(),setTimeout(function(){n.opacity(0).step(),this.setData({scoreAni:n.export()})}.bind(this),10)},handleClose:function(){this.triggerEvent("finish")},showRainResult:function(){this.cancelCustomAnimationFrame(animation),this.setData({showStatus:3,rainResult:{amount:100}})},customRequestAnimationFrame:function(t){var e=this,i=setTimeout(function(){t.call(e),clearTimeout(i)},1e3/60);return i},cancelCustomAnimationFrame:function(t){t&&(clearTimeout(t),animation=null)},doDrawRain:function(){var t=this.context,e=this.data,i=e.windowWidth,n=e.windowHeight;t.clearRect(0,0,i,n);for(var a=0;a<redEnvelopes.length;a+=1){var o=redEnvelopes[a],r=o.x,s=o.y,h=o.vx,m=o.vy,d=o.width,c=o.height,u=o.open,l=u?this.openEnvelopeImg:this.redEnvelopeImg,p=u?d+20:d,w=u?c+25:c;t.drawImage(l,r,s,p,w),o.x+=h,o.y+=m,o.y>=n&&(o.y=0,o.open=!1),o.x+d<=0&&(o.x=i-d,o.open=!1)}t.draw(),animation=this.customRequestAnimationFrame(this.doDrawRain)},randNum:function(t,e){return Math.floor(t+Math.random()*(e-t))},initRainDrops:function(){for(var t=this.data,e=t.windowWidth,i=t.windowHeight,n=t.createSpeed,a=t.max,o=t.min,r=0;r<10;r+=1){var s=Math.floor(Math.random()*e),h=Math.floor(Math.random()*i),m=this.randNum(minWidth,maxWidth),d=Math.floor(m/.8),c=1*Math.random()+n,u=this.randNum(o,a+1);redEnvelopes.push({x:s,y:h,vx:-1,vy:c,score:u,width:m,height:d,open:!1})}this.doDrawRain()},handleClickRain:function(t){for(var e=t.touches[0],i=e.x,n=e.y,a=0;a<redEnvelopes.length;a+=1){var o=redEnvelopes[a],r=o.x,s=o.y,h=o.width,m=o.height,d=i-r,c=n-s;if(-20<=d&&d<=h+20&&-20<=c&&c<=m+20){this.animationOfScore(i,n),innerAudioContext.play(),o.open=!0;var u=this.data.showScore+o.score;this.setData({showScore:u,showChangeScore:o.score});break}}},initRain:function(){this.context=wx.createCanvasContext("rain-canvas",this),this.redEnvelopeImg="./images/red-packet-rain.png",this.openEnvelopeImg="./images/red-packet-rain-open.png",this.initRainDrops(),this.audioOfClick()},handleScrollTouch:function(){},audioOfClick:function(){innerAudioContext.autoplay=!1,innerAudioContext.src="https://www.sunniejs.cn/static/weapp/dianji.mp3",innerAudioContext.onPlay(function(){}),innerAudioContext.onError(function(t){})}}});