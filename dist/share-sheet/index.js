"use strict";var _drawer=require("../../utils/drawer"),_wx=require("../../utils/wx");Component({externalClasses:["sol-class"],properties:{shareData:{type:Object,value:{}},mode:{type:String,value:"bar"},onlyFriend:{type:Boolean,value:!1},visible:{type:Boolean,value:!1},transparent:{type:Boolean,value:!1}},data:{cache:{"pages/index/index123456":"https://tweapp.top1buyer.com/dg/weapp/qrcode.jpg"},imgVisible:!1,shareImage:"",painting:{}},ready:function(){wx.setStorageSync("code_img_cache",this.data.cache)},methods:{onImgClose:function(){this.setData({imgVisible:!1})},onShareClose:function(){this.setData({visible:!1})},doShareDiscover:function(){var e=this.data.shareData,a=e.sharePath.substr(1).split("?")[0];this.drawCanvas(e.shareParams,a,340)},drawCanvas:function(e,a,t){var s=this,i={scene:e,page:a,width:2<arguments.length&&void 0!==t?t:200,auto_color:!1,r:"0",g:"0",b:"0",is_hyaline:!1};this.getCacheImage(i).then(function(e){var a=Object.assign(s.data.shareData,{qrcode:e});return(0,_drawer.drawTemplate)(a)}).then(function(e){wx.setStorageSync("code_img_cache",s.data.cache),wx.showLoading({title:"生成专属二维码",mask:!0}),s.setData({visible:!1,painting:e})}).catch(function(e){console.log(e)})},getCacheImage:function(e){var t=this,s=e.page+e.scene;return new Promise(function(e,a){t.data.cache[s]&&e(t.data.cache[s])})},doGetImage:function(e){wx.hideLoading();var a=e.detail,t=a.tempFilePath,s=a.errMsg;"path"!=this.properties.mode?"canvasdrawer:ok"===s?this.setData({imgVisible:!0,shareImage:t}):"canvasdrawer:same params"===s?this.data.shareImage?this.setData({imgVisible:!0}):wx.showToast({title:"生成图片失败",icon:"none"}):(wx.showToast({title:"生成图片失败",icon:"none"}),this.data.shareImage=""):this.triggerEvent("getPath",{tempFilePath:t,errMsg:s})},saveImg:function(){var a=this;(0,_wx.wxSaveAuth)().then(function(e){wx.saveImageToPhotosAlbum({filePath:a.data.shareImage,success:function(e){wx.showToast({title:"保存图片成功",icon:"success",duration:2e3}),a.setData({imgVisible:!1})},fail:function(e){wx.showToast({title:"保存图片失败",icon:"none",duration:2e3})}})})}}});