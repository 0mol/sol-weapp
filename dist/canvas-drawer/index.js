"use strict";function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,a)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(i,!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}Component({properties:{painting:{type:Object,value:{view:[]},observer:function(t,e){this.data.isPainting||(JSON.stringify(t)!==JSON.stringify(e)?t&&t.width&&t.height&&(this.setData({showCanvas:!0,isPainting:!0}),this.readyPigment()):t&&"same"!==t.mode&&this.triggerEvent("getImage",{errMsg:"canvasdrawer:same params"}))}}},data:{showCanvas:!1,width:100,height:100,tempFileList:[],isPainting:!1},ctx:null,cache:{},ready:function(){wx.removeStorageSync("canvasdrawer_pic_cache"),this.cache=wx.getStorageSync("canvasdrawer_pic_cache")||{},this.ctx=wx.createCanvasContext("canvasdrawer",this)},methods:{readyPigment:function(){var t=this,e=this.data.painting,i=e.width,a=e.height,r=e.views;this.setData({width:i,height:a});var n=setInterval(function(){t.ctx&&(clearInterval(n),t.ctx.clearActions(),t.ctx.save(),t.getImagesInfo(r))},100)},group:function(t,e){for(var i=0,a=[];i<t.length;)a.push(t.slice(i,i+=e));return a},getImagesInfo:function(t){for(var a=this,r=[],e=0;e<t.length;e++)"image"===t[e].type&&r.push(this.getImageInfo(t[e].url));for(var i=[],n=0;n<r.length;)i.push(new Promise(function(e,i){Promise.all(r.slice(n,n+=8)).then(function(t){e(t)}).catch(function(t){i(t)})}));Promise.all(i).then(function(t){for(var e=[],i=0;i<t.length;i++)e=e.concat(t[i]);a.setData({tempFileList:e}),a.startPainting()})},startPainting:function(){for(var e=this,t=this.data,i=t.tempFileList,a=t.painting.views,r=0,n=0;r<a.length;r++)if("image"===a[r].type)this.drawImage(_objectSpread({},a[r],{url:i[n]})),n++;else if("text"===a[r].type){if(!this.ctx.measureText)return wx.showModal({title:"提示",content:"当前微信版本过低，请升级到最新微信版本后重试。"}),this.triggerEvent("getImage",{errMsg:"canvasdrawer:version too low"}),void this.reset();this.drawText(a[r])}else"rect"===a[r].type&&this.drawRect(a[r]);this.ctx.draw(!1,function(){wx.setStorageSync("canvasdrawer_pic_cache",e.cache);var t=wx.getSystemInfoSync().system;/ios/i.test(t)?e.saveImageToLocal():setTimeout(function(){e.saveImageToLocal()},800)})},drawImage:function(t){this.ctx.save();var e=t.url,i=t.top,a=void 0===i?0:i,r=t.left,n=void 0===r?0:r,s=t.width,o=void 0===s?0:s,c=t.height,h=void 0===c?0:c,g=(t.borderRadius,t.deg),l=void 0===g?0:g;0!==l?(this.ctx.translate(n+o/2,a+h/2),this.ctx.rotate(l*Math.PI/180),this.ctx.drawImage(e,-o/2,-h/2,o,h)):this.ctx.drawImage(e,n,a,o,h),this.ctx.restore()},drawText:function(t){this.ctx.save();var e=t.MaxLineNumber,i=void 0===e?2:e,a=t.breakWord,r=void 0!==a&&a,n=t.color,s=void 0===n?"black":n,o=t.content,c=void 0===o?"":o,h=t.fontSize,g=void 0===h?16:h,l=t.top,d=void 0===l?0:l,v=t.left,x=void 0===v?0:v,f=t.lineHeight,w=void 0===f?20:f,u=t.textAlign,p=void 0===u?"left":u,m=t.width,I=t.bolder,P=void 0!==I&&I,y=t.textDecoration,T=void 0===y?"none":y;if(this.ctx.beginPath(),this.ctx.setTextBaseline("top"),this.ctx.setTextAlign(p),this.ctx.setFillStyle(s),this.ctx.setFontSize(g),r){for(var b="",S=d,O=1,M=0;M<c.length;M++)if(b+=[c[M]],this.ctx.measureText(b).width>m){if(O===i&&M!==c.length){b=b.substring(0,b.length-1)+"...",this.ctx.fillText(b,x,S),this.drawTextLine(x,S,T,s,g,b),b="";break}this.ctx.fillText(b,x,S),this.drawTextLine(x,S,T,s,g,b),b="",S+=w,O++}this.ctx.fillText(b,x,S),this.drawTextLine(x,S,T,s,g,b)}else this.ctx.fillText(c,x,d),this.drawTextLine(x,d,T,s,g,c);this.ctx.restore(),P&&this.drawText(_objectSpread({},t,{left:x+.3,top:d+.3,bolder:!1,textDecoration:"none"}))},drawTextLine:function(t,e,i,a,r,n){"underline"===i?this.drawRect({background:a,top:e+1.2*r,left:t-1,width:this.ctx.measureText(n).width+3,height:1}):"line-through"===i&&this.drawRect({background:a,top:e+.6*r,left:t-1,width:this.ctx.measureText(n).width+3,height:1})},drawRect:function(t){this.ctx.save();var e=t.background,i=t.top,a=void 0===i?0:i,r=t.left,n=void 0===r?0:r,s=t.width,o=void 0===s?0:s,c=t.height,h=void 0===c?0:c,g=t.radius,l=void 0===g?0:g;this.ctx.setFillStyle(e),l?(this.ctx.beginPath(),this.ctx.arc(n+l,a+l,l,Math.PI,1.5*Math.PI),this.ctx.moveTo(n+l,a),this.ctx.lineTo(n+o-l,a),this.ctx.lineTo(n+o,a+l),this.ctx.arc(n+o-l,a+l,l,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(n+o,a+h-l),this.ctx.lineTo(n+o-l,a+h),this.ctx.arc(n+o-l,a+h-l,l,0,.5*Math.PI),this.ctx.lineTo(n+l,a+h),this.ctx.lineTo(n,a+h-l),this.ctx.arc(n+l,a+h-l,l,.5*Math.PI,Math.PI),this.ctx.lineTo(n,a+l),this.ctx.lineTo(n+l,a),this.ctx.fill(),this.ctx.closePath()):this.ctx.fillRect(n,a,o,h),this.ctx.restore()},getImageInfo:function(a){var r=this;return a||(this.reset(),this.triggerEvent("getImage",{errMsg:"image:image url is none"})),new Promise(function(e,i){r.cache[a]?e(r.cache[a]):new RegExp(/^http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/).test(a)?wx.getImageInfo({src:a,complete:function(t){"getImageInfo:ok"===t.errMsg?(r.cache[a]=t.path,e(t.path)):(r.reset(),r.triggerEvent("getImage",{errMsg:"canvasdrawer:download fail"}),i(new Error("getImageInfo fail")))}}):(r.cache[a]=a,e(a))})},reset:function(){this.setData({showCanvas:!1,isPainting:!1,tempFileList:[]}),wx.removeStorageSync("canvasdrawer_pic_cache")},saveImageToLocal:function(){var e=this,t=this.data,i=t.width,a=t.height;wx.canvasToTempFilePath({x:0,y:0,width:i,height:a,canvasId:"canvasdrawer",complete:function(t){"canvasToTempFilePath:ok"===t.errMsg?(e.setData({showCanvas:!1,isPainting:!1,tempFileList:[]}),e.triggerEvent("getImage",{tempFilePath:t.tempFilePath,errMsg:"canvasdrawer:ok"})):(e.reset(),e.triggerEvent("getImage",{errMsg:"canvasdrawer:fail"}))}},this)}}});