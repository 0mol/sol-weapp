"use strict";var _painter=require("../../utils/painter"),_wx=require("../../utils/wx"),_util=require("../../utils/util");Component({externalClasses:["sol-class"],properties:{shareData:{type:Object,value:{},observer:function(a,t){(0,_util.isEmpty)(a)||(0,_util.equal)(a,t)||this.paintStart()}},mode:{type:String,value:"bar"},visible:{type:Boolean,value:!1,observer:function(a,t){"popup"!==this.data.mode&&this.setData({shareVisible:a})}},transparent:{type:Boolean,value:!1}},data:{imgVisible:!1,painting:!1,shareMsgData:{},sharePosterData:{},paintingCard:!1,imgPath:""},ready:function(){},methods:{paintStart:function(){console.log("paintStart");var a=this.data,t=a.shareData,e=a.mode,i=Object.assign({},{cardPoster:!1,shareType:"",shareParams:"",shareTitle:"",sharePath:"",shareImg:""},t);this.setData({shareMsgData:i,shareImage:""}),t.cardPoster&&this.drawCardCanvas(),"path"==e&&this.drawPosterCanvas()},drawCardCanvas:function(){var t=this;wx.showLoading({title:"正在加载",mask:!0});var a=this.data.shareData;this.data.paintingCard=!0,(0,_painter.drawCard)(a).then(function(a){t.setData({template:a})})},drawPosterCanvas:function(){var t=this,a=this.data,e=a.shareData,i=a.shareImage;return i&&-1!==i.indexOf("//tmp")?(this.setData({visible:!1,imgVisible:!0}),!1):!this.data.painting&&(this.data.painting=!0,void(0,_painter.drawPoster)(e).then(function(a){t.setData({template:a})}))},onImgClose:function(){this.setData({swiperIndex:0,imgVisible:!1})},onShareClose:function(){this.setData({visible:!1})},onImgOK:function(a){this.data.painting=!1,wx.hideLoading();var t=a.detail.path;return this.data.imgPath=t,this.data.paintingCard?(this.setData({"shareMsgData.shareImg":t}),this.data.paintingCard=!1):"path"==this.data.mode?(this.triggerEvent("path",t),!1):"popup"==this.data.mode?(this.setData({shareImage:t,imgVisible:!0}),!1):void this.setData({visible:!1,shareImage:t,imgVisible:!0})},saveImg:function(){var t=this;(0,_wx.wxSaveAuth)().then(function(a){wx.saveImageToPhotosAlbum({filePath:t.data.imgPath,success:function(a){wx.showToast({title:"保存图片成功",icon:"success",duration:2e3})},fail:function(a){wx.showToast({title:"保存图片失败",icon:"none",duration:2e3})}})})},drawCanvas:function(a,t,e){var i=this,s={scene:a,page:t,width:2<arguments.length&&void 0!==e?e:200,auto_color:!1,r:"0",g:"0",b:"0",is_hyaline:!1};this.getCacheImage(s).then(function(a){var t=Object.assign(i.data.shareData,{qrcode:a});return(0,_painter.drawPoster)(t)}).then(function(a){wx.setStorageSync("code_img_cache",i.data.cache),console.log(a),i.setData({template:a})}).catch(function(a){console.log(a)})},getCacheImage:function(a){var i=this,s=a.page+a.scene;return new Promise(function(t,e){i.data.cache[s]?t(i.data.cache[s]):getCodeUrl(a).then(function(a){i.data.cache[s]=a.codeUrl,t(a.codeUrl)}).catch(function(a){wx.showToast({title:"生成二维码失败,请稍后重试",icon:"none"}),e(a)})})}}});